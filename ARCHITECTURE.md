# System Architecture

This document describes the system architecture for local development and production (AWS) environments.

---

## Local Development Environment

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           DEVELOPER WORKSTATION                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                              BROWSER                                        │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │ │
│  │  │  React App (served by Vite)              http://localhost:5173       │  │ │
│  │  │                                                                      │  │ │
│  │  │  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────┐  │  │ │
│  │  │  │   UI Pages     │  │  Zustand       │  │   WASM Module          │  │  │ │
│  │  │  │   (React)      │  │  Stores        │  │   (client-core)        │  │  │ │
│  │  │  │                │  │                │  │                        │  │  │ │
│  │  │  │  • LoginPage   │  │  • AuthStore   │  │   Cryptography:        │  │  │ │
│  │  │  │  • VaultSetup  │  │  • VaultStore  │  │   • AES-256-GCM        │  │  │ │
│  │  │  │  • VaultPage   │  │  • SecretsStore│  │   • X25519 (ECDH)      │  │  │ │
│  │  │  │  • Settings    │  │                │  │   • Ed25519 (signing)  │  │  │ │
│  │  │  └────────────────┘  └────────────────┘  │                        │  │  │ │
│  │  │                                          │   Vault Operations:    │  │  │ │
│  │  │  ┌────────────────────────────────────┐  │   • createNew()        │  │  │ │
│  │  │  │         localStorage               │  │   • unlock()           │  │  │ │
│  │  │  │  • pm-device-key (DEK)             │  │   • encryptSecretKey() │  │  │ │
│  │  │  │  • pm-vault-data (encrypted)       │  │   • decryptSecretKey() │  │  │ │
│  │  │  │  • pm-auth (tokens)                │  │                        │  │  │ │
│  │  │  │  • pm-secrets (metadata cache)     │  └────────────────────────┘  │  │ │
│  │  │  └────────────────────────────────────┘                              │  │ │
│  │  │                                                                      │  │ │
│  │  └──────────────────────────────────┬───────────────────────────────────┘  │ │
│  └─────────────────────────────────────┼──────────────────────────────────────┘ │
│                                        │                                        │
│                                        │ HTTP (API calls to :3000)              │
│                                        ▼                                        │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  VITE DEV SERVER                                        localhost:5173     │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │ │
│  │  │  • Hot Module Replacement (HMR)                                      │  │ │
│  │  │  • TypeScript compilation                                            │  │ │
│  │  │  • WASM loading (.wasm files)                                        │  │ │
│  │  └──────────────────────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │  RUST SERVER (cargo run -p server)                      localhost:3000     │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │ │
│  │  │                           Axum Router                                │  │ │
│  │  │                                                                      │  │ │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌───────────┐ ┌─────────────┐  │  │ │
│  │  │  │  /keys  │ │/secrets │ │ /shares │ │/enrollments│ │   /sync     │  │  │ │
│  │  │  └────┬────┘ └────┬────┘ └────┬────┘ └─────┬─────┘ └──────┬──────┘  │  │ │
│  │  │       └───────────┴───────────┴────────────┴──────────────┘         │  │ │
│  │  │                              │                                       │  │ │
│  │  │  ┌───────────────────────────┴────────────────────────────────────┐ │  │ │
│  │  │  │                   CORS Middleware                               │ │  │ │
│  │  │  │  Allow-Origin: * (local dev only)                              │ │  │ │
│  │  │  └───────────────────────────┬────────────────────────────────────┘ │  │ │
│  │  │                              │                                       │  │ │
│  │  │  ┌───────────────────────────┴────────────────────────────────────┐ │  │ │
│  │  │  │                     Auth Middleware                             │ │  │ │
│  │  │  │  JWT validation via JWKS from Zitadel (:8080)                  │ │  │ │
│  │  │  │  Extracts principal_id from 'sub' claim                        │ │  │ │
│  │  │  └───────────────────────────┬────────────────────────────────────┘ │  │ │
│  │  │                              │                                       │  │ │
│  │  │  ┌───────────────────────────┴────────────────────────────────────┐ │  │ │
│  │  │  │                      Services                                   │ │  │ │
│  │  │  │  TransparencyLog │ AuditService │ Metrics (Prometheus)         │ │  │ │
│  │  │  └───────────────────────────┬────────────────────────────────────┘ │  │ │
│  │  │                              │                                       │  │ │
│  │  │  ┌───────────────────────────┴────────────────────────────────────┐ │  │ │
│  │  │  │                    Database Layer (sqlx)                        │ │  │ │
│  │  │  │  db::principals │ db::secrets │ db::secret_access              │ │  │ │
│  │  │  └───────────────────────────┬────────────────────────────────────┘ │  │ │
│  │  └──────────────────────────────┼──────────────────────────────────────┘  │ │
│  └─────────────────────────────────┼──────────────────────────────────────────┘ │
│                                    │                                             │
│ ───────────────────────────────────┼─────────────────────────────────────────── │
│                                    │                                             │
│  ┌─────────────────────────────────┼──────────────────────────────────────────┐ │
│  │  DOCKER COMPOSE (dev/docker-compose.yml)                                   │ │
│  │                                 │                                          │ │
│  │    ┌────────────────────────────┼────────────────────────────────────┐    │ │
│  │    │                            ▼                                    │    │ │
│  │    │  ┌─────────────────────────────────────────────────────────┐   │    │ │
│  │    │  │  PostgreSQL 16                          localhost:5432   │   │    │ │
│  │    │  │  ┌─────────────────────────────────────────────────────┐│   │    │ │
│  │    │  │  │  database: password_manager                         ││   │    │ │
│  │    │  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐││   │    │ │
│  │    │  │  │  │  principals  │ │   secrets    │ │secret_access │││   │    │ │
│  │    │  │  │  ├──────────────┤ ├──────────────┤ ├──────────────┤││   │    │ │
│  │    │  │  │  │  vault_keys  │ │user_devices  │ │   blocked    │││   │    │ │
│  │    │  │  │  ├──────────────┤ ├──────────────┤ ├──────────────┤││   │    │ │
│  │    │  │  │  │  key_log     │ │  audit_logs  │ │ enrollments  │││   │    │ │
│  │    │  │  │  └──────────────┘ └──────────────┘ └──────────────┘││   │    │ │
│  │    │  │  └─────────────────────────────────────────────────────┘│   │    │ │
│  │    │  └─────────────────────────────────────────────────────────┘   │    │ │
│  │    │                                                                │    │ │
│  │    │  ┌─────────────────────────────────────────────────────────┐   │    │ │
│  │    │  │  Zitadel (Identity Provider)            localhost:8080   │   │    │ │
│  │    │  │  ┌─────────────────────────────────────────────────────┐│   │    │ │
│  │    │  │  │  • OAuth 2.0 / OIDC                                 ││   │    │ │
│  │    │  │  │  • PKCE Authorization Code Flow                     ││   │    │ │
│  │    │  │  │  • JWT access tokens (not opaque)                   ││   │    │ │
│  │    │  │  │  • JWKS endpoint: /oauth/v2/keys                    ││◄──┼────┼─┐
│  │    │  │  │  • User management: /ui/console                     ││   │    │ │ │
│  │    │  │  └─────────────────────────────────────────────────────┘│   │    │ │ │
│  │    │  └─────────────────────────────────────────────────────────┘   │    │ │ │
│  │    │                                                                │    │ │ │
│  │    │  ┌─────────────────────────────────────────────────────────┐   │    │ │ │
│  │    │  │  OpenFGA (Authorization)                localhost:8081   │   │    │ │ │
│  │    │  │  ┌─────────────────────────────────────────────────────┐│   │    │ │ │
│  │    │  │  │  • Fine-grained authorization (ReBAC)               ││   │    │ │ │
│  │    │  │  │  • Relationship tuples: user:X owner secret:Y       ││   │    │ │ │
│  │    │  │  │  • Check API for permission queries                 ││   │    │ │ │
│  │    │  │  └─────────────────────────────────────────────────────┘│   │    │ │ │
│  │    │  └─────────────────────────────────────────────────────────┘   │    │ │ │
│  │    │                                                                │    │ │ │
│  │    │  ┌─────────────────────────────────────────────────────────┐   │    │ │ │
│  │    │  │  Mailpit (SMTP)                         localhost:8025   │   │    │ │ │
│  │    │  │  ┌─────────────────────────────────────────────────────┐│   │    │ │ │
│  │    │  │  │  • Fake SMTP server for Zitadel emails              ││   │    │ │ │
│  │    │  │  │  • Web UI: http://localhost:8025                    ││   │    │ │ │
│  │    │  │  │  • SMTP port: 1025                                  ││   │    │ │ │
│  │    │  │  └─────────────────────────────────────────────────────┘│   │    │ │ │
│  │    │  └─────────────────────────────────────────────────────────┘   │    │ │ │
│  │    │                                                                │    │ │ │
│  │    └────────────────────────────────────────────────────────────────┘    │ │ │
│  └──────────────────────────────────────────────────────────────────────────┘ │ │
│                                                                                │ │
└────────────────────────────────────────────────────────────────────────────────┘ │
                                                                                   │
           Browser OAuth redirect ─────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                       CLIENT-SIDE KEY HIERARCHY                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Device Encryption Key (DEK)                                             │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │  • Generated once per device (browser)                          │    │   │
│   │  │  • Stored in localStorage (pm-device-key)                       │    │   │
│   │  │  • 32 bytes, AES-256 key                                        │    │   │
│   │  │  • Never leaves the device                                      │    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   │                              │                                           │   │
│   │                              │ encrypts                                  │   │
│   │                              ▼                                           │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Vault Private Keys (encrypted with DEK, stored in localStorage) │   │   │
│   │  │  ┌───────────────────────────────┐ ┌───────────────────────────┐│    │   │
│   │  │  │  key_exchange_secret (X25519) │ │  signing_key (Ed25519)    ││    │   │
│   │  │  │  • For encrypting secret keys │ │  • For signing operations ││    │   │
│   │  │  │    shared with other devices  │ │                           ││    │   │
│   │  │  └───────────────────────────────┘ └───────────────────────────┘│    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   │                              │                                           │   │
│   │                              │ encrypts (X25519 ECDH)                    │   │
│   │                              ▼                                           │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Per-Secret Keys (encrypted with vault public key)               │    │   │
│   │  │  ┌───────────────────────────────┐ ┌───────────────────────────┐│    │   │
│   │  │  │  content_key (AES-256-GCM)    │ │  metadata_key (AES-256)   ││    │   │
│   │  │  │  • Encrypts secret content    │ │  • Encrypts name/tags     ││    │   │
│   │  │  │  • Unique per secret          │ │  • Allows listing without ││    │   │
│   │  │  │                               │ │    decrypting content     ││    │   │
│   │  │  └───────────────────────────────┘ └───────────────────────────┘│    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                          │   │
│   │  ┌─────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Recovery Key                                                    │    │   │
│   │  │  • Shown once at vault creation                                  │    │   │
│   │  │  • Format: XXXXXXXX-XXXXXXXX-XXXXXXXX-XXXXXXXX (64 hex chars)    │    │   │
│   │  │  • Can decrypt vault keys if all devices lost                    │    │   │
│   │  │  • Hash stored in localStorage for verification                  │    │   │
│   │  └─────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                       DATA FLOW: Create Secret (Local Dev)                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   USER enters secret data in AddSecretModal                                      │
│     │                                                                            │
│     ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  WASM (client-core)                                                      │   │
│   │                                                                          │   │
│   │  1. createLoginSecret(username, password, url, name)                     │   │
│   │     • Generate content_key (32 bytes)                                    │   │
│   │     • Generate metadata_key (32 bytes)                                   │   │
│   │     • Encrypt content with content_key (AES-256-GCM)                     │   │
│   │     • Encrypt metadata with metadata_key (AES-256-GCM)                   │   │
│   │                                                                          │   │
│   │  2. encryptSecretKeyForVault(content_key, vault_public_key)              │   │
│   │     • X25519 key exchange with ephemeral keypair                         │   │
│   │     • Returns: { ephemeral_public_key, encrypted_key }                   │   │
│   │                                                                          │   │
│   │  3. encryptSecretKeyForVault(metadata_key, vault_public_key)             │   │
│   │     • Same process for metadata key                                      │   │
│   └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                      │                                           │
│                                      ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  POST /api/v1/secrets                                                    │   │
│   │  Authorization: Bearer <JWT>                                             │   │
│   │  {                                                                       │   │
│   │    "encrypted_data": "<base64 encrypted content>",                       │   │
│   │    "encrypted_secret_key": "<base64 X25519 package>",     ◄── NOT raw!   │   │
│   │    "encrypted_metadata_key": "<base64 X25519 package>",                  │   │
│   │    "encrypted_metadata": "<base64 encrypted metadata>"                   │   │
│   │  }                                                                       │   │
│   └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                      │                                           │
│                                      ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  Rust Server                                                             │   │
│   │                                                                          │   │
│   │  • Validates JWT, extracts principal_id                                  │   │
│   │  • Auto-creates principal if first request                               │   │
│   │  • Stores encrypted blobs in PostgreSQL                                  │   │
│   │  • Server NEVER sees plaintext - only encrypted bytes                    │   │
│   └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                      │                                           │
│                                      ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  PostgreSQL                                                              │   │
│   │                                                                          │   │
│   │  secrets table:                                                          │   │
│   │  ┌────────────┬─────────────────────────────────────────────────────┐   │   │
│   │  │ id         │ uuid                                                │   │   │
│   │  │ encrypted  │ \x8a15... (AES-256-GCM ciphertext)                  │   │   │
│   │  │ _data      │                                                     │   │   │
│   │  └────────────┴─────────────────────────────────────────────────────┘   │   │
│   │                                                                          │   │
│   │  secret_access table:                                                    │   │
│   │  ┌────────────┬─────────────────────────────────────────────────────┐   │   │
│   │  │ secret_id  │ uuid (FK to secrets)                                │   │   │
│   │  │ principal  │ "456..." (Zitadel user ID)                          │   │   │
│   │  │ encrypted  │ {"ephemeral_public_key":[...], "encrypted_key":[...]}│  │   │
│   │  │ _secret_key│ (X25519 package, JSON serialized)                   │   │   │
│   │  │ encrypted  │ (same structure)                                    │   │   │
│   │  │ _metadata  │                                                     │   │   │
│   │  │ _key       │                                                     │   │   │
│   │  └────────────┴─────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                       DATA FLOW: Read Secret (Local Dev)                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   USER clicks on secret in VaultPage                                             │
│     │                                                                            │
│     ▼                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  GET /api/v1/secrets/:id                                                 │   │
│   │  Authorization: Bearer <JWT>                                             │   │
│   │                                                                          │   │
│   │  Response:                                                               │   │
│   │  {                                                                       │   │
│   │    "encrypted_data": "<base64>",                                         │   │
│   │    "encrypted_secret_key": "<base64 X25519 package>",                    │   │
│   │    "encrypted_metadata_key": "<base64 X25519 package>",                  │   │
│   │    "encrypted_metadata": "<base64>"                                      │   │
│   │  }                                                                       │   │
│   └──────────────────────────────────┬──────────────────────────────────────┘   │
│                                      │                                           │
│                                      ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │  WASM (client-core) - SecretDetailModal                                  │   │
│   │                                                                          │   │
│   │  1. decryptSecretKeyWithVault(encrypted_secret_key, vault_private_key)   │   │
│   │     • Parse X25519 package                                               │   │
│   │     • ECDH with vault private key + ephemeral public key                 │   │
│   │     • Derive shared secret, decrypt content_key                          │   │
│   │     • Returns: 32-byte content_key                                       │   │
│   │                                                                          │   │
│   │  2. decryptSecretContent(encrypted_data, content_key)                    │   │
│   │     • AES-256-GCM decrypt                                                │   │
│   │     • Returns: JSON { type, fields: { username, password, url, ... } }   │   │
│   │                                                                          │   │
│   │  3. Display decrypted values in UI                                       │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
│   NOTE: Decryption happens entirely in browser. Server only stores ciphertext.  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                          LOCAL DEV COMMANDS                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  # Terminal 1: Start infrastructure                                              │
│  $ cd dev && docker compose up -d                                                │
│                                                                                  │
│  # Terminal 2: Start backend server                                              │
│  $ cargo run -p server 2>&1 | tee /tmp/server.log                                │
│                                                                                  │
│  # Terminal 3: Start web client                                                  │
│  $ cd clients && yarn dev                                                        │
│                                                                                  │
│  # Build WASM (after Rust changes)                                               │
│  $ wasm-pack build crates/client-core --target web \                             │
│      --out-dir ../../clients/shared/src/wasm/pkg                                 │
│                                                                                  │
│  # View Zitadel admin console                                                    │
│  $ open http://localhost:8080/ui/console                                         │
│                                                                                  │
│  # View Mailpit (captured emails)                                                │
│  $ open http://localhost:8025                                                    │
│                                                                                  │
│  # Query database                                                                │
│  $ docker exec dev-postgres-1 psql -U postgres -d password_manager               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                          LOCAL DEV PORTS                                         │
├──────────────────┬──────────────────────────────────────────────────────────────┤
│  localhost:5173  │  Vite Dev Server (Web Client)                                │
│  localhost:3000  │  Rust API Server                                             │
│  localhost:5432  │  PostgreSQL                                                  │
│  localhost:8080  │  Zitadel (Identity Provider + Admin Console)                 │
│  localhost:8081  │  OpenFGA (Authorization)                                     │
│  localhost:8025  │  Mailpit Web UI (captured emails)                            │
│  localhost:1025  │  Mailpit SMTP (for Zitadel)                                  │
└──────────────────┴──────────────────────────────────────────────────────────────┘
```

---

## Production Environment (AWS)

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                        INTERNET                                          │
└───────────────────────────────────────────┬─────────────────────────────────────────────┘
                                            │
                                            ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                     AWS CLOUD                                            │
│  ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              EDGE / CDN LAYER                                      │  │
│  │                                                                                    │  │
│  │    ┌────────────────────────────────────────────────────────────────────────┐     │  │
│  │    │                         Route 53 (DNS)                                  │     │  │
│  │    │    app.passwordmanager.com ──► CloudFront                              │     │  │
│  │    │    api.passwordmanager.com ──► ALB                                     │     │  │
│  │    │    auth.passwordmanager.com ─► Zitadel ALB                             │     │  │
│  │    └────────────────────────────────────────────────────────────────────────┘     │  │
│  │                          │                              │                          │  │
│  │                          ▼                              ▼                          │  │
│  │    ┌──────────────────────────────┐    ┌──────────────────────────────────────┐   │  │
│  │    │   CloudFront Distribution    │    │          AWS WAF                      │   │  │
│  │    │   (Web App CDN)              │    │   • Rate limiting                     │   │  │
│  │    │   ┌────────────────────────┐ │    │   • SQL injection protection          │   │  │
│  │    │   │ • Static assets (S3)   │ │    │   • XSS protection                    │   │  │
│  │    │   │ • HTTPS/TLS 1.3        │ │    │   • Geo-blocking (optional)           │   │  │
│  │    │   │ • Gzip/Brotli          │ │    │   • Bot detection                     │   │  │
│  │    │   │ • Cache headers        │ │    └──────────────────┬───────────────────┘   │  │
│  │    │   └────────────────────────┘ │                       │                        │  │
│  │    └──────────────┬───────────────┘                       │                        │  │
│  │                   │                                       │                        │  │
│  └───────────────────┼───────────────────────────────────────┼────────────────────────┘  │
│                      │                                       │                           │
│  ┌───────────────────┼───────────────────────────────────────┼────────────────────────┐  │
│  │                   │            VPC (10.0.0.0/16)          │                        │  │
│  │                   │                                       │                        │  │
│  │  ┌────────────────┼───────────────────────────────────────┼──────────────────────┐│  │
│  │  │                ▼              PUBLIC SUBNETS           ▼                      ││  │
│  │  │  ┌──────────────────────────┐              ┌──────────────────────────────┐  ││  │
│  │  │  │     S3 Bucket            │              │  Application Load Balancer   │  ││  │
│  │  │  │  (Web App Static)        │              │  (API & Auth)                │  ││  │
│  │  │  │  ┌────────────────────┐  │              │  ┌────────────────────────┐  │  ││  │
│  │  │  │  │ • index.html       │  │              │  │ • HTTPS listener :443  │  │  ││  │
│  │  │  │  │ • assets/*.js      │  │              │  │ • ACM certificate      │  │  ││  │
│  │  │  │  │ • assets/*.css     │  │              │  │ • Health checks        │  │  ││  │
│  │  │  │  │ • assets/*.wasm    │  │              │  │ • Target groups:       │  │  ││  │
│  │  │  │  │ • Versioned builds │  │              │  │   - /api/* → API svc   │  │  ││  │
│  │  │  │  └────────────────────┘  │              │  │   - /* → Zitadel       │  │  ││  │
│  │  │  └──────────────────────────┘              │  └────────────────────────┘  │  ││  │
│  │  │                                            └───────────────┬──────────────┘  ││  │
│  │  └────────────────────────────────────────────────────────────┼──────────────────┘│  │
│  │                                                               │                   │  │
│  │  ┌────────────────────────────────────────────────────────────┼──────────────────┐│  │
│  │  │                          PRIVATE SUBNETS                   │                  ││  │
│  │  │                                                            │                  ││  │
│  │  │  ┌─────────────────────────────────────────────────────────┼────────────────┐││  │
│  │  │  │                    ECS CLUSTER (Fargate)                │                │││  │
│  │  │  │                                                         ▼                │││  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────────┐│││  │
│  │  │  │  │                     API Service                                      ││││  │
│  │  │  │  │  ┌─────────────────────────────────────────────────────────────┐   ││││  │
│  │  │  │  │  │  Task Definition: password-manager-api                      │   ││││  │
│  │  │  │  │  │  ┌─────────────────────────────────────────────────────┐   │   ││││  │
│  │  │  │  │  │  │  Container: api                                     │   │   ││││  │
│  │  │  │  │  │  │  Image: ECR/password-manager-api:latest             │   │   ││││  │
│  │  │  │  │  │  │  Port: 3000                                         │   │   ││││  │
│  │  │  │  │  │  │  CPU: 512  Memory: 1024 MB                          │   │   ││││  │
│  │  │  │  │  │  │  ┌───────────────────────────────────────────────┐ │   │   ││││  │
│  │  │  │  │  │  │  │  Environment:                                 │ │   │   ││││  │
│  │  │  │  │  │  │  │  • DATABASE_URL (from Secrets Manager)        │ │   │   ││││  │
│  │  │  │  │  │  │  │  • JWT_ISSUER, JWT_AUDIENCE                   │ │   │   ││││  │
│  │  │  │  │  │  │  │  • JWKS_URL → Zitadel                         │ │   │   ││││  │
│  │  │  │  │  │  │  │  • OPENFGA_URL → OpenFGA service              │ │   │   ││││  │
│  │  │  │  │  │  │  │  • SERVER_SIGNING_KEY (Secrets Manager)       │ │   │   ││││  │
│  │  │  │  │  │  │  └───────────────────────────────────────────────┘ │   │   ││││  │
│  │  │  │  │  │  └─────────────────────────────────────────────────────┘   │   ││││  │
│  │  │  │  │  │  Desired Count: 2 (Multi-AZ)                               │   ││││  │
│  │  │  │  │  │  Auto Scaling: 2-10 based on CPU/Request count             │   ││││  │
│  │  │  │  │  └─────────────────────────────────────────────────────────────┘   ││││  │
│  │  │  │  └─────────────────────────────────────────────────────────────────────┘│││  │
│  │  │  │                                                                         │││  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────────┐│││  │
│  │  │  │  │                   Zitadel Service                                    ││││  │
│  │  │  │  │  ┌─────────────────────────────────────────────────────────────┐   ││││  │
│  │  │  │  │  │  Task: zitadel                                              │   ││││  │
│  │  │  │  │  │  Image: ghcr.io/zitadel/zitadel:latest                      │   ││││  │
│  │  │  │  │  │  Port: 8080                                                 │   ││││  │
│  │  │  │  │  │  CPU: 1024  Memory: 2048 MB                                 │   ││││  │
│  │  │  │  │  │  Desired Count: 2                                           │   ││││  │
│  │  │  │  │  └─────────────────────────────────────────────────────────────┘   ││││  │
│  │  │  │  └─────────────────────────────────────────────────────────────────────┘│││  │
│  │  │  │                                                                         │││  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────────┐│││  │
│  │  │  │  │                   OpenFGA Service                                    ││││  │
│  │  │  │  │  ┌─────────────────────────────────────────────────────────────┐   ││││  │
│  │  │  │  │  │  Task: openfga                                              │   ││││  │
│  │  │  │  │  │  Image: openfga/openfga:latest                              │   ││││  │
│  │  │  │  │  │  Port: 8081                                                 │   ││││  │
│  │  │  │  │  │  CPU: 512  Memory: 1024 MB                                  │   ││││  │
│  │  │  │  │  │  Desired Count: 2                                           │   ││││  │
│  │  │  │  │  └─────────────────────────────────────────────────────────────┘   ││││  │
│  │  │  │  └─────────────────────────────────────────────────────────────────────┘│││  │
│  │  │  │                                                                         │││  │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘││  │
│  │  │                                    │                                        ││  │
│  │  │                                    │                                        ││  │
│  │  │  ┌─────────────────────────────────┼──────────────────────────────────────┐││  │
│  │  │  │                       DATA LAYER│                                      │││  │
│  │  │  │                                 ▼                                      │││  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────┐  │││  │
│  │  │  │  │                    Amazon RDS (PostgreSQL 16)                    │  │││  │
│  │  │  │  │  ┌───────────────────────────────────────────────────────────┐  │  │││  │
│  │  │  │  │  │  Instance: db.r6g.large (Multi-AZ)                        │  │  │││  │
│  │  │  │  │  │  Storage: 100 GB gp3 (encrypted)                          │  │  │││  │
│  │  │  │  │  │  ┌─────────────────────────────────────────────────────┐  │  │  │││  │
│  │  │  │  │  │  │  Primary (us-east-1a)    Standby (us-east-1b)       │  │  │  │││  │
│  │  │  │  │  │  │       ┌───┐                    ┌───┐                │  │  │  │││  │
│  │  │  │  │  │  │       │ P │◄──── sync ────────►│ S │                │  │  │  │││  │
│  │  │  │  │  │  │       └───┘                    └───┘                │  │  │  │││  │
│  │  │  │  │  │  └─────────────────────────────────────────────────────┘  │  │  │││  │
│  │  │  │  │  │  • Automated backups (35 days)                            │  │  │││  │
│  │  │  │  │  │  • Point-in-time recovery                                 │  │  │││  │
│  │  │  │  │  │  • Performance Insights enabled                           │  │  │││  │
│  │  │  │  │  └───────────────────────────────────────────────────────────┘  │  │││  │
│  │  │  │  └─────────────────────────────────────────────────────────────────┘  │││  │
│  │  │  │                                                                        │││  │
│  │  │  │  ┌─────────────────────────────────────────────────────────────────┐  │││  │
│  │  │  │  │                 ElastiCache (Redis 7)                            │  │││  │
│  │  │  │  │  ┌───────────────────────────────────────────────────────────┐  │  │││  │
│  │  │  │  │  │  Cluster: cache.r6g.large                                 │  │  │││  │
│  │  │  │  │  │  • JWKS cache                                             │  │  │││  │
│  │  │  │  │  │  • Session cache                                          │  │  │││  │
│  │  │  │  │  │  • Rate limiting counters                                 │  │  │││  │
│  │  │  │  │  │  • Encryption at rest & in transit                        │  │  │││  │
│  │  │  │  │  └───────────────────────────────────────────────────────────┘  │  │││  │
│  │  │  │  └─────────────────────────────────────────────────────────────────┘  │││  │
│  │  │  │                                                                        │││  │
│  │  │  └────────────────────────────────────────────────────────────────────────┘││  │
│  │  │                                                                            ││  │
│  │  └────────────────────────────────────────────────────────────────────────────┘│  │
│  │                                                                                │  │
│  └────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐  │
│  │                           SECURITY & SECRETS                                   │  │
│  │                                                                                │  │
│  │  ┌────────────────────────┐  ┌────────────────────────┐  ┌──────────────────┐ │  │
│  │  │   Secrets Manager      │  │        KMS             │  │   IAM Roles      │ │  │
│  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │ ┌──────────────┐ │ │  │
│  │  │  │ • DATABASE_URL   │  │  │  │ • RDS encryption │  │  │ │ ECS Task     │ │ │  │
│  │  │  │ • SERVER_SIGNING │  │  │  │ • S3 encryption  │  │  │ │ Role         │ │ │  │
│  │  │  │   _KEY           │  │  │  │ • Secrets Mgr    │  │  │ │              │ │ │  │
│  │  │  │ • ZITADEL_MASTER │  │  │  │   encryption     │  │  │ │ Permissions: │ │ │  │
│  │  │  │   _KEY           │  │  │  │ • ElastiCache    │  │  │ │ • RDS access │ │ │  │
│  │  │  │                  │  │  │  │   encryption     │  │  │ │ • Secrets    │ │ │  │
│  │  │  │ Auto-rotation:   │  │  │  └──────────────────┘  │  │ │ • CloudWatch │ │ │  │
│  │  │  │ 90 days          │  │  │                        │  │ │ • X-Ray      │ │ │  │
│  │  │  └──────────────────┘  │  │                        │  │ └──────────────┘ │ │  │
│  │  └────────────────────────┘  └────────────────────────┘  └──────────────────┘ │  │
│  │                                                                                │  │
│  └────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐  │
│  │                          OBSERVABILITY                                         │  │
│  │                                                                                │  │
│  │  ┌────────────────────────┐  ┌────────────────────────┐  ┌──────────────────┐ │  │
│  │  │   CloudWatch           │  │       X-Ray            │  │   CloudWatch     │ │  │
│  │  │   Logs                 │  │                        │  │   Alarms         │ │  │
│  │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │  │ ┌──────────────┐ │ │  │
│  │  │  │ • API access logs│  │  │  │ • Request tracing│  │  │ │ • 5xx rate   │ │ │  │
│  │  │  │ • Application    │  │  │  │ • Service map    │  │  │ │ • Latency    │ │ │  │
│  │  │  │   logs           │  │  │  │ • Error analysis │  │  │ │   p99        │ │ │  │
│  │  │  │ • Audit logs     │  │  │  │                  │  │  │ │ • DB conn    │ │ │  │
│  │  │  │ • 30 day retain  │  │  │  │                  │  │  │ │   pool       │ │ │  │
│  │  │  └──────────────────┘  │  │  └──────────────────┘  │  │ │ • CPU/Memory │ │ │  │
│  │  └────────────────────────┘  └────────────────────────┘  │ └──────────────┘ │ │  │
│  │                                                          └──────────────────┘ │  │
│  └────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌────────────────────────────────────────────────────────────────────────────────┐  │
│  │                             CI/CD PIPELINE                                     │  │
│  │                                                                                │  │
│  │  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐│  │
│  │  │  GitHub  │───►│CodeBuild │───►│   ECR    │───►│CodeDeploy│───►│   ECS    ││  │
│  │  │          │    │          │    │          │    │ (B/G)    │    │          ││  │
│  │  │ • Push   │    │ • Build  │    │ • Store  │    │ • Deploy │    │ • Run    ││  │
│  │  │ • PR     │    │ • Test   │    │   image  │    │ • Rollback│   │          ││  │
│  │  │ • Tag    │    │ • Scan   │    │ • Scan   │    │          │    │          ││  │
│  │  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘│  │
│  │                                                                                │  │
│  │  Web Client: GitHub → CodeBuild → S3 → CloudFront invalidation                │  │
│  │                                                                                │  │
│  └────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Production Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                         REQUEST FLOW: Create Secret                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   USER                                                                                   │
│     │                                                                                    │
│     │ 1. Enter secret data in browser                                                   │
│     ▼                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│   │  BROWSER (Web App from CloudFront/S3)                                            │   │
│   │                                                                                  │   │
│   │  2. WASM encrypts locally:                                                       │   │
│   │     • Generate content_key, metadata_key (AES-256)                               │   │
│   │     • Encrypt secret content with content_key                                    │   │
│   │     • Encrypt metadata with metadata_key                                         │   │
│   │     • Encrypt keys with user's vault public key (X25519)                         │   │
│   │                                                                                  │   │
│   │  3. POST /api/v1/secrets                                                         │   │
│   │     Authorization: Bearer <JWT from Zitadel>                                     │   │
│   │     Body: { encrypted_content, encrypted_metadata, encrypted_keys }              │   │
│   └──────────────────────────────────────────┬──────────────────────────────────────┘   │
│                                              │                                           │
│                                              ▼                                           │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│   │  CLOUDFRONT → WAF                                                                 │  │
│   │  • Rate limiting check                                                            │  │
│   │  • WAF rules evaluation                                                           │  │
│   │  • Forward to ALB                                                                 │  │
│   └──────────────────────────────────────────┬───────────────────────────────────────┘  │
│                                              │                                           │
│                                              ▼                                           │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│   │  ALB → ECS API Service                                                            │  │
│   │                                                                                   │  │
│   │  4. Auth middleware:                                                              │  │
│   │     • Extract JWT from Authorization header                                       │  │
│   │     • Fetch JWKS from Zitadel (cached in Redis)                                   │  │
│   │     • Validate signature, issuer, audience, expiry                                │  │
│   │     • Extract principal_id (sub claim)                                            │  │
│   │                                                                                   │  │
│   │  5. API handler:                                                                  │  │
│   │     • Validate request body                                                       │  │
│   │     • Generate secret_id (UUID)                                                   │  │
│   └──────────────────────────────────────────┬───────────────────────────────────────┘  │
│                                              │                                           │
│                        ┌─────────────────────┼─────────────────────┐                    │
│                        ▼                     ▼                     ▼                    │
│   ┌────────────────────────┐  ┌────────────────────────┐  ┌────────────────────────┐   │
│   │  RDS (PostgreSQL)      │  │  OpenFGA               │  │  CloudWatch            │   │
│   │                        │  │                        │  │                        │   │
│   │  6. Insert into DB:    │  │  7. Create tuple:      │  │  8. Audit log:         │   │
│   │  • secrets table       │  │  user:{principal_id}   │  │  • secret.created      │   │
│   │  • secret_access table │  │    owner               │  │  • principal_id        │   │
│   │  • transparency_log    │  │    secret:{secret_id}  │  │  • secret_id           │   │
│   │                        │  │                        │  │  • timestamp           │   │
│   └────────────────────────┘  └────────────────────────┘  └────────────────────────┘   │
│                                              │                                           │
│                                              ▼                                           │
│   ┌──────────────────────────────────────────────────────────────────────────────────┐  │
│   │  Response: 201 Created                                                            │  │
│   │  { "id": "secret-uuid", "created_at": "..." }                                     │  │
│   └──────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                          │
│   NOTE: Server NEVER sees plaintext secret data - only encrypted blobs                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Cost Estimation (AWS)

| Service | Configuration | Estimated Monthly Cost |
|---------|---------------|------------------------|
| ECS Fargate (API) | 2 tasks × 0.5 vCPU × 1GB | ~$30 |
| ECS Fargate (Zitadel) | 2 tasks × 1 vCPU × 2GB | ~$60 |
| ECS Fargate (OpenFGA) | 2 tasks × 0.5 vCPU × 1GB | ~$30 |
| RDS PostgreSQL | db.r6g.large Multi-AZ | ~$200 |
| ElastiCache Redis | cache.r6g.large | ~$100 |
| ALB | 1 ALB + data transfer | ~$25 |
| CloudFront | 100GB transfer/month | ~$10 |
| S3 | 1GB storage + requests | ~$1 |
| Route 53 | 1 hosted zone + queries | ~$1 |
| Secrets Manager | 5 secrets | ~$2 |
| CloudWatch | Logs + metrics | ~$20 |
| **Total** | | **~$480/month** |

*Costs vary by region and usage. Consider Reserved Instances or Savings Plans for production.*

---

## Security Checklist

### Network Security
- [ ] VPC with public/private subnet separation
- [ ] Security groups with least-privilege rules
- [ ] NACLs for subnet-level filtering
- [ ] VPC Flow Logs enabled
- [ ] No public IP on database/cache instances

### Data Security
- [ ] RDS encryption at rest (KMS)
- [ ] ElastiCache encryption at rest and in transit
- [ ] S3 bucket encryption (SSE-S3 or SSE-KMS)
- [ ] Secrets Manager for credentials
- [ ] No secrets in environment variables or code

### Application Security
- [ ] WAF rules enabled
- [ ] Rate limiting configured
- [ ] HTTPS only (redirect HTTP)
- [ ] Security headers (CSP, HSTS, etc.)
- [ ] Container image scanning

### Access Control
- [ ] IAM roles with least-privilege
- [ ] No IAM users for applications
- [ ] MFA on AWS root and admin accounts
- [ ] CloudTrail enabled for audit

### Monitoring
- [ ] CloudWatch alarms for critical metrics
- [ ] X-Ray tracing enabled
- [ ] Log retention policy set
- [ ] Incident response runbooks

---

## Deployment Commands

```bash
# Build and push API image
docker build -t password-manager-api -f Dockerfile.api .
aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_REPO
docker tag password-manager-api:latest $ECR_REPO/password-manager-api:latest
docker push $ECR_REPO/password-manager-api:latest

# Deploy via CDK/Terraform/CloudFormation
cd infra
cdk deploy --all

# Build and deploy web client
cd clients
yarn build
aws s3 sync web/dist s3://$WEB_BUCKET --delete
aws cloudfront create-invalidation --distribution-id $CF_DIST --paths "/*"
```
